name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build & Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript Typecheck
        run: npx tsc -b --noEmit 2>&1 || true
        # Typecheck as informational — some types depend on Electron runtime

      - name: Build (electron-vite)
        run: npx electron-vite build

      - name: Verify build output
        run: |
          test -f out/main/index.js || exit 1
          test -f out/preload/index.js || exit 1
          test -f out/renderer/index.html || exit 1
          echo "✅ All build artifacts present"
          echo "Main:     $(wc -c < out/main/index.js) bytes"
          echo "Preload:  $(wc -c < out/preload/index.js) bytes"
          echo "Renderer: $(du -sh out/renderer/ | cut -f1)"

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: npm audit
        run: npm audit --omit=dev || true
        # Report vulnerabilities but don't fail on dev-only issues
